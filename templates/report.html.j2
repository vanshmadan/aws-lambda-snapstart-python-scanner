<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SnapStart Bug Scan Report</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    header {
      background: #0d6efd;
      color: white;
      padding: 20px 40px;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .summary {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      flex: 1;
      min-width: 250px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px 20px;
    }
    h2, h3 {
      margin-top: 30px;
    }

    /* Severity colors */
    .severity.ERROR { color: #d9534f; font-weight: bold; }
    .severity.WARN  { color: #f0ad4e; font-weight: bold; }
    .severity.INFO  { color: #5bc0de; font-weight: bold; }

    /* Finding cards */
    .finding-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px 12px;
      margin: 8px 0;
      background: #fff;
      transition: all 0.2s ease;
    }
    .finding-card:hover {
      background: #f8f9fa;
    }

    details summary {
      color: #0d6efd;
      cursor: pointer;
      margin-top: 6px;
      font-size: 0.9rem;
    }

    pre {
      background: #0d1117;
      color: #f8f8f2;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .hit {
      background: #212529;
      color: #fff;
      padding: 0 4px;
      border-radius: 3px;
    }

    /* Filter buttons */
    .filters {
      margin-bottom: 20px;
    }
    .filters button {
      border: none;
      background: #e9ecef;
      color: #333;
      padding: 6px 12px;
      margin-right: 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .filters button.active {
      background: #0d6efd;
      color: white;
    }

    /* Collapsible groups */
    .group-header {
      background: #f1f3f5;
      border-radius: 8px;
      padding: 8px 12px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
    }
    .group-header:hover {
      background: #e9ecef;
    }

    .group-content {
      display: none;
      margin-top: 10px;
    }

    .group-content.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table td {
      padding: 4px 8px;
    }
  </style>
</head>
<body>

  <header>
    <h1>SnapStart Bug Scan Report</h1>
  </header>

  <div class="container">
    <div class="summary">
      <div class="card">
        <b>Repository:</b><br>{{ repo_root }}<br>
        <b>Findings:</b> {{ counts.ERROR + counts.WARN + counts.INFO }} |
        <b>Context:</b> {{ context_lines }} lines
      </div>
      <div class="card">
        <b>By Severity</b>
        <table>
          <tr><td><span class="severity ERROR">ERROR</span></td><td>{{ counts.ERROR }}</td></tr>
          <tr><td><span class="severity WARN">WARN</span></td><td>{{ counts.WARN }}</td></tr>
          <tr><td><span class="severity INFO">INFO</span></td><td>{{ counts.INFO }}</td></tr>
        </table>
      </div>
      <div class="card">
        <b>By Rule</b>
        <table>
          {% for rule, cnt in counts_by_rule.items() %}
          <tr><td>{{ rule }}</td><td>{{ cnt }}</td></tr>
          {% endfor %}
        </table>
      </div>
    </div>

    <h2>All Findings</h2>
    <div class="filters">
      <button class="filter-btn active" data-sev="ALL">All</button>
      <button class="filter-btn" data-sev="ERROR">Errors</button>
      <button class="filter-btn" data-sev="WARN">Warnings</button>
      <button class="filter-btn" data-sev="INFO">Info</button>
    </div>

    {% for severity in ["ERROR", "WARN", "INFO"] %}
      {% if grouped_findings[severity] %}
        <div class="group">
          <div class="group-header" onclick="toggleGroup('{{ severity }}')">
            ▶ <span class="severity {{ severity }}">{{ severity }}</span> ({{ grouped_findings[severity]|length }} findings)
          </div>
          <div id="group-{{ severity }}" class="group-content">
            {% for f in grouped_findings[severity] %}
              <div class="finding-card severity-{{ severity }}">
                <div>
                  <strong>{{ f.rule_id }}</strong> — {{ f.filename }}:{{ f.lineno }}
                </div>
                <div>{{ f.message }}</div>

                {% if f.context %}
                <details>
                  <summary>Show code context</summary>
                  <pre><code>
{% for line in f.context %}
{{ "%4d" % line.n }} | {% if line.is_hit %}<span class="hit">{{ line.text|e }}</span>{% else %}{{ line.text|e }}{% endif %}
{% endfor %}
                  </code></pre>
                </details>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endfor %}

  </div>

  <script>
    // Filter buttons
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const sev = btn.dataset.sev;
        document.querySelectorAll('.group').forEach(g => {
  	if (sev === 'ALL' || g.innerHTML.includes(sev)) {
    	g.style.display = '';
  	} else {
    	g.style.display = 'none';
  	} 
       });
      });
    });

    // Expand/collapse severity groups
    function toggleGroup(sev) {
      const el = document.getElementById('group-' + sev);
      if (el.classList.contains('active')) {
        el.classList.remove('active');
      } else {
        el.classList.add('active');
      }
    }
  </script>
</body>
</html>
